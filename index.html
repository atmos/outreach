<!-- Originally taken from http://awardwinningfjords.com/2011/12/27/emberjs-collections.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Loud on Twitter : GitHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style type="text/css">
    body {background: #333; font-size: 64px; color: #999; margin: 0; padding: 0}
    ul { margin-top: 5px; padding-left: 0; }
    img { border: 1px solid #fff; }
    .twitter-posts {padding: 10px; margin-left: 5px; list-style-position: inside; list-style-type:none; border-bottom: 1px solid #000;}
    .twitter-posts a {text-decoration:none; color: #FFF;}
  </style>
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="js/twitter-text.min.js"></script>
  <script src="js/ember-0.9.5.min.js"></script>
  <script src="js/ember/data.js"></script>
  <script src="js/ember/localStorage.js"></script>
</head>
<body>
  <script type="text/x-handlebars">
    Loud tweets about {{Twitter.config.account}}...
    <div>
      <ul>
      {{#each Twitter.searchResults}}
        <li class="twitter-posts">
          <img src="{{unbound avatar}}" alt="{{unbound from_user}}" />
          <a href="{{unbound userLink}}" class="profile" target="tab">@{{from_user}}({{followers}})</a> <a href="{{unbound link}}" target="tab">says...</a>
          <div class="tweet">{{{tweetText}}}</div>
        </li>
      {{/each}}
      </ul>
    </div>
  </script>
  <script>
    // Namespace
    Twitter = Em.Application.create({
      ready: function() {
        // Polling
        setInterval(function() {
          Twitter.searchResults.refresh()
        }, Twitter.config.refreshRate * 1000)

        Twitter.searchResults.set("query", Twitter.config.account)
        this._super()
      }
    })

    // Choose the account to follow and the min followers required
    Twitter.config = {
      account: "@GitHub",
      refreshRate: 60,
      minFollowers: 500
    }

    // Persistence
    Twitter.store = DS.Store.create({
      adapter:  DS.localStorageAdapter.create({bulkCommit: true}),
      revision: 4
    })

    Twitter.findUser = function(name) {
      var user  = null
        , users = Twitter.store.findAll(Twitter.User)

      users.forEach(function(u) {
        if(u.get("screen_name") == name)
          user = u
      })
      if(user === null) {
        var url  = "http://api.twitter.com/1/users/lookup.json?callback=?&screen_name="
        $.getJSON(url + name, function(profiles) {
          $.each(profiles, function(count, author) {
            user = Twitter.store.createRecord(Twitter.User, author)
            Twitter.store.commit()
          })
        })
      }
      return user
    }

    //// Models
    Twitter.User = DS.Model.extend({
      name:            DS.attr('string'),
      followers_count: DS.attr('integer'),

      link: function() {
        return ("https://twitter.com/" + this.get("screen_name"))
      }.property(),
    })

    Twitter.Tweet = Em.Object.extend({
      link: function() {
        return(this.get("userLink") + "/status/" + this.get("id_str"))
      }.property(),
      userLink: function() {
        return this.user().get("link")
      }.property(),
      tweetText: function() {
        return twttr.txt.autoLink(this.get("text"))
      }.property(),
      user: function() {
        return Twitter.findUser(this.get("from_user"))
      },
      followers: function() {
        return this.user().get("followers_count")
      }.property(),
      avatar: function() {
        return this.user().get("profile_image_url")
      }.property()
    })
    // Collection
    Twitter.searchResults = Em.ArrayController.create({
      query: null,
      content: [],
      _idCache: {},

      addTweet: function(tweet) {
        var   id = tweet.get("id")
          , user = null
          , self = this

        if (typeof this._idCache[id] === "undefined") {
          user = Twitter.findUser(tweet.get("from_user"))
          if(user) {
            console.log(tweet.get("from_user") + " : " + user.get("followers_count"))
            if(user.get("followers_count") > Twitter.config.minFollowers) {
              self.unshiftObject(tweet)
            }
            this._idCache[id] = tweet.id
          }
        }
      },

      refresh: function() {
        var query = this.get("query")
          , self = this
          , url = "http://search.twitter.com/search.json?limit=10000&rpp=100&q=" + query + "&callback=?"

        $.getJSON(url, function(data) {
          for (var i = data.results.length-1; i >= 0; i--) {
            self.addTweet(Twitter.Tweet.create(data.results[i]))
          }
        })
      }.observes("query")
    })
  </script>
</body>
</html>
